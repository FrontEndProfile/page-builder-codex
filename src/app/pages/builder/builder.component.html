<div class="builder app-page" *ngIf="page">
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-card">
      <div class="spinner"></div>
      <p>{{ loadingMessage }}</p>
    </div>
  </div>
  <header class="builder__topbar">
    <div class="topbar__title">
      <h2>{{ page.name }}</h2>
      <span>Last updated {{ page.updatedAt | date: 'short' }}</span>
    </div>
    <div class="topbar__actions">
      <div class="view-toggle">
        <button type="button" [class.active]="viewMode === 'desktop'" (click)="viewMode = 'desktop'" title="Desktop view">
          <i class="fa-solid fa-desktop"></i>
        </button>
        <button type="button" [class.active]="viewMode === 'tablet'" (click)="viewMode = 'tablet'" title="Tablet view">
          <i class="fa-solid fa-tablet-screen-button"></i>
        </button>
        <button type="button" [class.active]="viewMode === 'mobile'" (click)="viewMode = 'mobile'" title="Mobile view">
          <i class="fa-solid fa-mobile-screen-button"></i>
        </button>
      </div>
      <button type="button" class="icon-only" (click)="save()" title="Save">
        <i class="fa-solid fa-floppy-disk"></i>
      </button>
      <button type="button" class="icon-only" [disabled]="!canUndo" (click)="undo()" title="Undo">
        <i class="fa-solid fa-rotate-left"></i>
      </button>
      <button type="button" class="icon-only" [disabled]="!canRedo" (click)="redo()" title="Redo">
        <i class="fa-solid fa-rotate-right"></i>
      </button>
      <button
        type="button"
        class="icon-only danger"
        [disabled]="!selectedNode || selectedNode.id === page.root.id"
        (click)="deleteSelected()"
        title="Delete selected"
      >
        <i class="fa-solid fa-trash"></i>
      </button>
      <button type="button" class="icon-only" (click)="openPreview()" title="Preview">
        <i class="fa-solid fa-eye"></i>
      </button>
      <button type="button" class="icon-only" (click)="showExportModal = true" title="Export">
        <i class="fa-solid fa-file-export"></i>
      </button>
      <button type="button" class="icon-only" (click)="openVersions()" title="Versions">
        <i class="fa-solid fa-clock-rotate-left"></i>
      </button>
      <button type="button" class="icon-only" (click)="exportJson()" title="Export JSON">
        <i class="fa-solid fa-code"></i>
      </button>
      <label class="import-button">
        <i class="fa-solid fa-file-import" title="Import JSON"></i>
        <input type="file" accept="application/json" (change)="handleImportFile($event)" />
      </label>
    </div>
  </header>

  <div class="builder__layout">
    <aside class="builder__sidebar" [class.builder__sidebar--collapsed]="!sidebarMode">
      <div class="sidebar__rail">
        <button type="button" [class.active]="sidebarMode === 'add'" (click)="toggleSidebar('add')">+</button>
        <button type="button" [class.active]="sidebarMode === 'pages'" (click)="toggleSidebar('pages')">ðŸ“„</button>
        <button type="button" [class.active]="sidebarMode === 'navigator'" (click)="toggleSidebar('navigator')">â˜°</button>
        <button type="button" class="ghost">âš™</button>
      </div>

      <div class="sidebar__panel" *ngIf="sidebarMode === 'add'">
        <div class="sidebar__tabs">
          <button type="button" [class.active]="addTab === 'elements'" (click)="addTab = 'elements'">
            Elements
          </button>
          <button type="button" [class.active]="addTab === 'layouts'" (click)="addTab = 'layouts'">
            Layouts
          </button>
        </div>
        <div *ngIf="addTab === 'elements'">
          <div class="library-group" *ngFor="let group of libraryGroups">
            <h3>{{ group.title }}</h3>
            <div class="library">
              <div class="library__item" *ngFor="let item of group.items">
                <div>
                  <strong>{{ item.label }}</strong>
                  <p>{{ item.description }}</p>
                </div>
                <button type="button" (click)="addNode(item.type)">Add</button>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="addTab === 'layouts'" class="hint">
          Layout presets coming soon.
        </div>
      </div>

      <div class="sidebar__panel" *ngIf="sidebarMode === 'pages'">
        <div class="panel__title">
          <h3>Pages</h3>
          <button type="button" class="icon-button" (click)="togglePageSettings()" aria-label="Page settings">
            âš™
          </button>
        </div>
        <div class="project__create-page">
          <input [(ngModel)]="newPageName" placeholder="New page name" />
          <button type="button" (click)="createPageInline()">Add Page</button>
        </div>
        <div class="project__pages">
          <div class="page" *ngFor="let pageItem of projectPages">
            <div>
              <h4>{{ pageItem.name }}</h4>
              <span>Updated {{ pageItem.updatedAt | date: 'short' }}</span>
            </div>
            <div class="page__actions">
              <button
                type="button"
                [class.active]="pageItem.id === pageId"
                [disabled]="pageItem.id === pageId"
                (click)="openPage(pageItem.id)"
              >
                {{ pageItem.id === pageId ? 'Current' : 'Open' }}
              </button>
              <button
                type="button"
                class="icon-button page-settings-btn"
                *ngIf="pageItem.id === pageId"
                (click)="togglePageSettings()"
              >
                âš™
              </button>
            </div>
          </div>
        </div>

        <div class="page-settings" *ngIf="showPageSettings">
          <div class="page-settings__header">
            <h4>Page Settings</h4>
            <button type="button" class="icon-button" (click)="togglePageSettings()" aria-label="Close settings">
              âœ•
            </button>
          </div>

          <div class="page-settings__section">
            <label>Page Name</label>
            <input [ngModel]="page.name" (ngModelChange)="updatePageName($event)" />
          </div>

          <div class="page-settings__section">
            <h5>SEO Settings</h5>
            <label>Title Tag</label>
            <input [ngModel]="getSeoValue('titleTag')" (ngModelChange)="updateSeoValue('titleTag', $event)" />
            <label>Meta Description</label>
            <textarea
              [ngModel]="getSeoValue('metaDescription')"
              (ngModelChange)="updateSeoValue('metaDescription', $event)"
            ></textarea>
            <div class="toggle-row">
              <span>Sitemap Indexing</span>
              <label class="switch">
                <input
                  type="checkbox"
                  [checked]="getSitemapIndex()"
                  (change)="updateSeoValue('sitemapIndex', $any($event.target).checked)"
                />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="page-settings__section">
            <h5>Open Graph</h5>
            <label>Open Graph Title</label>
            <input [ngModel]="getSeoValue('ogTitle')" (ngModelChange)="updateSeoValue('ogTitle', $event)" />
            <label>Open Graph Description</label>
            <textarea
              [ngModel]="getSeoValue('ogDescription')"
              (ngModelChange)="updateSeoValue('ogDescription', $event)"
            ></textarea>
            <label>Open Graph Image</label>
            <label class="upload-button og-upload">
              <span>{{ ogLoading ? 'Uploading...' : 'Upload image' }}</span>
              <input type="file" accept="image/*" (change)="handleOgImageUpload($event)" />
            </label>
            <div class="og-grid" *ngIf="ogImages.length">
              <button
                type="button"
                class="og-card"
                *ngFor="let url of ogImages"
                [class.active]="getSeoValue('ogImage') === url"
                (click)="selectOgImage(url)"
              >
                <div class="og-card__image" [style.backgroundImage]="'url(' + url + ')'"></div>
              </button>
            </div>
            <div class="og-preview">
              <div class="og-preview__image" [style.backgroundImage]="'url(' + getSeoValue('ogImage') + ')'"></div>
              <div>
                <strong>{{ getSeoValue('ogTitle') || page.name }}</strong>
                <p>{{ getSeoValue('ogDescription') || 'Preview description' }}</p>
              </div>
            </div>
          </div>

          <div class="page-settings__section">
            <h5>Search Result Preview</h5>
            <div class="search-preview">
              <strong>{{ getSeoValue('titleTag') || page.name }}</strong>
              <span>{{ (page.name || 'page') + '.com/' + page.id }}</span>
              <p>{{ getSeoValue('metaDescription') || 'Meta description will appear here.' }}</p>
            </div>
          </div>

          <div class="page-settings__section danger-zone">
            <h5>Danger zone</h5>
            <button type="button" class="danger" (click)="requestDeletePage()">Delete current page</button>
          </div>
        </div>
      </div>

      <div class="sidebar__panel layers" *ngIf="sidebarMode === 'navigator'">
        <h3>Navigator</h3>
        <ng-container
          *ngTemplateOutlet="layerNode; context: { $implicit: page.root, depth: 0, parentId: null, index: 0 }"
        ></ng-container>
      </div>
    </aside>

    <main class="builder__canvas" (click)="builder.selectNode(null)">
      <div
        class="canvas__frame"
        [class.canvas__frame--tablet]="viewMode === 'tablet'"
        [class.canvas__frame--mobile]="viewMode === 'mobile'"
        [ngStyle]="viewMode === 'desktop' ? null : { width: frameWidth[viewMode] + 'px' }"
      >
        <div
          class="canvas__inner"
          [ngStyle]="{
            background: page.settings.baseBg,
            color: page.settings.baseTextColor,
            fontFamily: page.settings.primaryFont
          }"
        >
        <app-node-renderer
          [node]="page.root"
          [selectedId]="builder.selectedId"
          [parentId]="null"
          [index]="0"
          [viewport]="viewMode"
          (selectNode)="selectNode($event)"
          (startDrag)="handleStartDrag($event)"
          (startResize)="handleStartResize($event)"
          (reorder)="handleReorder($event)"
          (quickUpdate)="handleQuickUpdate($event)"
        ></app-node-renderer>
        </div>
        <button
          type="button"
          class="canvas__resize-handle"
          *ngIf="viewMode !== 'desktop'"
          (mousedown)="startFrameResize($event, viewMode === 'tablet' ? 'tablet' : 'mobile')"
        >
          â†”
        </button>
      </div>
    </main>

    <aside class="builder__properties">
      <app-properties-panel
        [node]="selectedNode"
        [projectId]="projectId"
        [pageId]="pageId"
        [viewMode]="viewMode"
      ></app-properties-panel>
    </aside>
  </div>
</div>

<div class="modal" *ngIf="showExportModal">
  <div class="modal__content">
    <h3>Export</h3>
    <p>Select the export format for your page.</p>
    <div class="modal__actions">
      <button type="button" (click)="exportStatic()">Static HTML + CSS</button>
      <button type="button" (click)="exportAngular()">Angular Component</button>
    </div>
    <button type="button" class="ghost" (click)="showExportModal = false">Close</button>
  </div>
</div>

<div class="modal" *ngIf="showVersionsModal">
  <div class="modal__content">
    <h3>Versions</h3>
    <p *ngIf="versionsLoading">Loading versions...</p>
    <div class="version-list" *ngIf="!versionsLoading">
      <button
        type="button"
        class="version-item"
        *ngFor="let version of versions"
        (click)="restoreVersion(version.id)"
      >
        <span>{{ version.note }}</span>
        <small>{{ version.createdAt | date: 'short' }}</small>
      </button>
      <p class="hint" *ngIf="!versions.length">No versions yet.</p>
    </div>
    <button type="button" class="ghost" (click)="showVersionsModal = false">Close</button>
  </div>
</div>

<div class="modal" *ngIf="showUnsavedModal">
  <div class="modal__content">
    <h3>Unsaved changes</h3>
    <p>You have unsaved changes. Save before switching pages?</p>
    <div class="modal__actions">
      <button type="button" (click)="confirmNavigate(true)">Save & Continue</button>
      <button type="button" class="ghost" (click)="confirmNavigate(false)">Discard</button>
    </div>
  </div>
</div>

<div class="modal" *ngIf="showDeletePageModal">
  <div class="modal__content">
    <h3>Delete page?</h3>
    <p>This will permanently remove the current page.</p>
    <div class="modal__actions">
      <button type="button" class="danger" (click)="confirmDeletePage()">Delete</button>
      <button type="button" class="ghost" (click)="showDeletePageModal = false">Cancel</button>
    </div>
  </div>
</div>

<ng-template #layerNode let-node let-depth="depth" let-parentId="parentId" let-index="index">
  <div class="layers__item" [class.layers__item--selected]="node.id === builder.selectedId" [style.paddingLeft.px]="depth * 10">
    <div class="layers__row">
      <button
        type="button"
        class="layers__toggle"
        [class.layers__toggle--hidden]="!node.children?.length"
        (click)="toggleExpanded(node)"
      >
        <span [class.layers__toggle--open]="isExpanded(node)">â–¸</span>
      </button>
      <span class="layers__icon">â–£</span>
      <button type="button" class="layers__label" (click)="selectNode(node)">
        {{ getLayerLabel(node) }}
      </button>
    </div>
    <div class="layers__actions">
      <button
        type="button"
        class="ghost"
        [disabled]="!canMoveLayer(node, -1)"
        (click)="moveLayer(node, -1)"
      >
        â†‘
      </button>
      <button
        type="button"
        class="ghost"
        [disabled]="!canMoveLayer(node, 1)"
        (click)="moveLayer(node, 1)"
      >
        â†“
      </button>
      <button
        type="button"
        class="danger"
        (click)="builder.deleteNode(node.id)"
        [disabled]="!page || node.id === page.root.id"
      >
        âœ•
      </button>
    </div>
  </div>
  <div class="layers__children" *ngIf="canAcceptChildren(node)" [class.layers__children--empty]="!node.children?.length">
    <ng-container *ngIf="isExpanded(node)">
      <ng-container *ngFor="let child of node.children ?? []; trackBy: trackById">
        <ng-container
          *ngTemplateOutlet="
            layerNode;
            context: {
              $implicit: child,
              depth: depth + 1,
              parentId: node.id,
              index: node.children?.indexOf(child) ?? 0
            }
          "
        ></ng-container>
      </ng-container>
    </ng-container>
  </div>
</ng-template>
