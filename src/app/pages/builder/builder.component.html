<div class="builder app-page" *ngIf="page">
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-card">
      <div class="spinner"></div>
      <p>{{ loadingMessage }}</p>
    </div>
  </div>
  <header class="builder__topbar">
    <div class="topbar__title">
      <h2>{{ page.name }}</h2>
      <span>Last updated {{ page.updatedAt | date: 'short' }}</span>
    </div>
    <div class="topbar__actions">
      <div class="view-toggle">
        <button type="button" [class.active]="viewMode === 'desktop'" (click)="viewMode = 'desktop'">Desktop</button>
        <button type="button" [class.active]="viewMode === 'tablet'" (click)="viewMode = 'tablet'">Tablet</button>
        <button type="button" [class.active]="viewMode === 'mobile'" (click)="viewMode = 'mobile'">Mobile</button>
      </div>
      <button type="button" (click)="save()">Save</button>
      <button type="button" [disabled]="!canUndo" (click)="undo()">Undo</button>
      <button type="button" [disabled]="!canRedo" (click)="redo()">Redo</button>
      <button type="button" class="danger" [disabled]="!selectedNode || selectedNode.id === page.root.id" (click)="deleteSelected()">
        Delete
      </button>
      <button type="button" (click)="openPreview()">Preview</button>
      <button type="button" (click)="showExportModal = true">Export</button>
      <button type="button" (click)="openVersions()">Versions</button>
      <button type="button" (click)="exportJson()">Export JSON</button>
      <label class="import-button">
        Import JSON
        <input type="file" accept="application/json" (change)="handleImportFile($event)" />
      </label>
    </div>
  </header>

  <div class="builder__layout">
    <aside class="builder__sidebar">
      <div class="sidebar__rail">
        <button type="button" [class.active]="sidebarMode === 'add'" (click)="sidebarMode = 'add'">+</button>
        <button type="button" [class.active]="sidebarMode === 'pages'" (click)="sidebarMode = 'pages'">ðŸ“„</button>
        <button type="button" [class.active]="sidebarMode === 'navigator'" (click)="sidebarMode = 'navigator'">â˜°</button>
        <button type="button" class="ghost">âš™</button>
      </div>

      <div class="sidebar__panel" *ngIf="sidebarMode === 'add'">
        <div class="sidebar__tabs">
          <button type="button" [class.active]="addTab === 'elements'" (click)="addTab = 'elements'">
            Elements
          </button>
          <button type="button" [class.active]="addTab === 'layouts'" (click)="addTab = 'layouts'">
            Layouts
          </button>
        </div>
        <div *ngIf="addTab === 'elements'">
          <div class="library-group" *ngFor="let group of libraryGroups">
            <h3>{{ group.title }}</h3>
            <div class="library">
              <div class="library__item" *ngFor="let item of group.items">
                <div>
                  <strong>{{ item.label }}</strong>
                  <p>{{ item.description }}</p>
                </div>
                <button type="button" (click)="addNode(item.type)">Add</button>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="addTab === 'layouts'" class="hint">
          Layout presets coming soon.
        </div>
      </div>

      <div class="sidebar__panel" *ngIf="sidebarMode === 'pages'">
        <h3>Pages</h3>
        <div class="project__create-page">
          <input [(ngModel)]="newPageName" placeholder="New page name" />
          <button type="button" (click)="createPageInline()">Add Page</button>
        </div>
        <div class="project__pages">
          <div class="page" *ngFor="let pageItem of projectPages">
            <div>
              <h4>{{ pageItem.name }}</h4>
              <span>Updated {{ pageItem.updatedAt | date: 'short' }}</span>
            </div>
            <div class="page__actions">
              <button
                type="button"
                [class.active]="pageItem.id === pageId"
                [disabled]="pageItem.id === pageId"
                (click)="openPage(pageItem.id)"
              >
                {{ pageItem.id === pageId ? 'Current' : 'Open' }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="sidebar__panel layers" *ngIf="sidebarMode === 'navigator'">
        <h3>Navigator</h3>
        <ng-container
          *ngTemplateOutlet="layerNode; context: { $implicit: page.root, depth: 0, parentId: null, index: 0 }"
        ></ng-container>
      </div>
    </aside>

    <main class="builder__canvas" (click)="builder.selectNode(null)">
      <div
        class="canvas__frame"
        [class.canvas__frame--tablet]="viewMode === 'tablet'"
        [class.canvas__frame--mobile]="viewMode === 'mobile'"
        [ngStyle]="viewMode === 'desktop' ? null : { width: frameWidth[viewMode] + 'px' }"
      >
        <div
          class="canvas__inner"
          [ngStyle]="{
            background: page.settings.baseBg,
            color: page.settings.baseTextColor,
            fontFamily: page.settings.primaryFont
          }"
        >
        <app-node-renderer
          [node]="page.root"
          [selectedId]="builder.selectedId"
          [parentId]="null"
          [index]="0"
          [viewport]="viewMode"
          (selectNode)="selectNode($event)"
          (startDrag)="handleStartDrag($event)"
          (startResize)="handleStartResize($event)"
          (reorder)="handleReorder($event)"
          (quickUpdate)="handleQuickUpdate($event)"
        ></app-node-renderer>
        </div>
        <button
          type="button"
          class="canvas__resize-handle"
          *ngIf="viewMode !== 'desktop'"
          (mousedown)="startFrameResize($event, viewMode === 'tablet' ? 'tablet' : 'mobile')"
        >
          â†”
        </button>
      </div>
    </main>

    <aside class="builder__properties">
      <app-properties-panel
        [node]="selectedNode"
        [projectId]="projectId"
        [pageId]="pageId"
        [viewMode]="viewMode"
      ></app-properties-panel>
    </aside>
  </div>
</div>

<div class="modal" *ngIf="showExportModal">
  <div class="modal__content">
    <h3>Export</h3>
    <p>Select the export format for your page.</p>
    <div class="modal__actions">
      <button type="button" (click)="exportStatic()">Static HTML + CSS</button>
      <button type="button" (click)="exportAngular()">Angular Component</button>
    </div>
    <button type="button" class="ghost" (click)="showExportModal = false">Close</button>
  </div>
</div>

<div class="modal" *ngIf="showVersionsModal">
  <div class="modal__content">
    <h3>Versions</h3>
    <p *ngIf="versionsLoading">Loading versions...</p>
    <div class="version-list" *ngIf="!versionsLoading">
      <button
        type="button"
        class="version-item"
        *ngFor="let version of versions"
        (click)="restoreVersion(version.id)"
      >
        <span>{{ version.note }}</span>
        <small>{{ version.createdAt | date: 'short' }}</small>
      </button>
      <p class="hint" *ngIf="!versions.length">No versions yet.</p>
    </div>
    <button type="button" class="ghost" (click)="showVersionsModal = false">Close</button>
  </div>
</div>

<div class="modal" *ngIf="showUnsavedModal">
  <div class="modal__content">
    <h3>Unsaved changes</h3>
    <p>You have unsaved changes. Save before switching pages?</p>
    <div class="modal__actions">
      <button type="button" (click)="confirmNavigate(true)">Save & Continue</button>
      <button type="button" class="ghost" (click)="confirmNavigate(false)">Discard</button>
    </div>
  </div>
</div>

<ng-template #layerNode let-node let-depth="depth" let-parentId="parentId" let-index="index">
  <div class="layers__item" [class.layers__item--selected]="node.id === builder.selectedId" [style.paddingLeft.px]="depth * 10">
    <div class="layers__row">
      <button
        type="button"
        class="layers__toggle"
        [class.layers__toggle--hidden]="!node.children?.length"
        (click)="toggleExpanded(node)"
      >
        <span [class.layers__toggle--open]="isExpanded(node)">â–¸</span>
      </button>
      <span class="layers__icon">â–£</span>
      <button type="button" class="layers__label" (click)="selectNode(node)">
        {{ getLayerLabel(node) }}
      </button>
    </div>
    <div class="layers__actions">
      <button
        type="button"
        class="ghost"
        [disabled]="!canMoveLayer(node, -1)"
        (click)="moveLayer(node, -1)"
      >
        â†‘
      </button>
      <button
        type="button"
        class="ghost"
        [disabled]="!canMoveLayer(node, 1)"
        (click)="moveLayer(node, 1)"
      >
        â†“
      </button>
      <button
        type="button"
        class="danger"
        (click)="builder.deleteNode(node.id)"
        [disabled]="!page || node.id === page.root.id"
      >
        âœ•
      </button>
    </div>
  </div>
  <div class="layers__children" *ngIf="canAcceptChildren(node)" [class.layers__children--empty]="!node.children?.length">
    <ng-container *ngIf="isExpanded(node)">
      <ng-container *ngFor="let child of node.children ?? []; trackBy: trackById">
        <ng-container
          *ngTemplateOutlet="
            layerNode;
            context: {
              $implicit: child,
              depth: depth + 1,
              parentId: node.id,
              index: node.children?.indexOf(child) ?? 0
            }
          "
        ></ng-container>
      </ng-container>
    </ng-container>
  </div>
</ng-template>
